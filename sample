pipeline {
    environment {
        registry = "noel135/img-repo"
        registryCredential = 'docker-credential'
        dockerImage = ''
        docker_version = "${BUILD_NUMBER}"
        deployment_file = "${WORKSPACE}/deployment.yaml"
        KUBECONFIG_CREDENTIAL_ID = 'kubeconfig' // Define this
    }
    agent any
    stages {
        node {
          stage('Apply Kubernetes files') {
           withKubeConfig([credentialsId: 'kubeconfig', serverUrl: '100.96.44.203']) {
           sh 'kubectl apply -f ${deployment_file} -n noelapp'
         }
       }
      }
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withCredentials([file(credentialsId: kubeconfig, variable: 'KUBECONFIG')]) {
                        sh 'kubectl apply -f ${deployment_file} -n noelapp'
                    }
                }
            }
        }
        stage('Verify Deployment') {
            steps {
                script {
                    sh 'kubectl rollout status deployment/my-deployment'
                }
            }
        }
        stage('Cleaning up') {
            steps {
                script {
                    sh 'docker rmi $registry:$BUILD_NUMBER'
                }
            }
        }
    }
}
